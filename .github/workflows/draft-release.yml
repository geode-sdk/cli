name: Draft Release

on:
  workflow_dispatch:

jobs:
  draft:
    name: Draft release
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Define variables
        id: info
        run: |
          VERSION=v$(cat Cargo.toml | sed -nr 's/version = \"(.+)\"/\1/p' | head -1)
          BRANCH=main
          API_URL="https://api.github.com/repos/geode-sdk/cli/actions/workflows/build.yml/runs?per_page=1&branch=$BRANCH&event=push&status=success"
          RUN_ID=$(curl $API_URL | jq .workflow_runs[0].id)

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

      - name: Download artifacts
        id: download-artifact
        uses: dawidd6/action-download-artifact@v7
        with:
          run_id: ${{ steps.info.outputs.run_id }}
          path: ${{ github.workspace }}/artifacts

      - name: Rename files
        run: |
          cd ${{ github.workspace }}/artifacts
          mv geode-cli-win.zip geode-cli-${{ steps.info.outputs.version }}-win.zip
          mv geode-cli-mac.zip geode-cli-${{ steps.info.outputs.version }}-mac.zip
          mv geode-cli-linux.zip geode-cli-${{ steps.info.outputs.version }}-linux.zip

      - name: Create draft release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.info.outputs.version }}
          name: CLI ${{ steps.info.outputs.version }}
          body: |
            ## Changelog
            - Something
          draft: true
          files: |
            ./artifacts/*.zip
