# TODO: Update the WinGet one too :P

name: Update CLI Manifests

on:
  workflow_dispatch:
  release:
    types:
      - released

jobs:
  trigger:
    name: Update homebrew repo
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout homebrew repository
      uses: actions/checkout@v4
      with:
        repository: geode-sdk/homebrew-geode
        path: homebrew-geode
        token: ${{ secrets.GEODE_BOT_PUSH_BIN_TOKEN }}

    - name: Fetch release info
      uses: actions/github-script@v7
      id: fetch-mac-release
      with:
        result-encoding: string
        script: |
          let rel = await github.rest.repos.getLatestRelease({
            owner: 'geode-sdk',
            repo: 'cli',
          });

          for (let asset of rel.data.assets) {
            if (asset.name.endsWith('-mac.zip')) {
              return asset.browser_download_url;
            }
          }

    - name: Update macOS homebrew repo
      shell: bash
      run: |
        URL="${{ steps.fetch-mac-release.outputs.result }}"
        GEODE_HASH=$(curl -L $URL | sha256sum | awk '{print $1}')
        cd homebrew-geode/Formula
        cp geode-cli.rb.in geode-cli.rb
        sed -i -e "s|DOWNLOAD_URL|$URL|g" geode-cli.rb
        sed -i -e "s/HASH/$GEODE_HASH/g" geode-cli.rb

    - name: Push to repo
      shell: bash
      working-directory: ${{ github.workspace }}/homebrew-geode
      run: |
        git config --local user.email "${{ secrets.GEODE_BOT_EMAIL }}"
        git config --local user.name "GeodeBot"
        git add .
        git commit -m "Update CLI"
        git remote set-url origin "https://GeodeBot:${{ secrets.GEODE_BOT_PUSH_BIN_TOKEN }}@github.com/geode-sdk/homebrew-geode.git"
        git push || true
